# 手牌学習データ作成システム設計書（改訂版）

## 1. システム概要

### 1.1 目的
麻雀対局動画から手牌（プレイヤーが持っている牌）の領域を抽出し、各牌を正確にラベリングすることで、AI学習用の高品質なデータセットを作成する。既存の麻雀牌譜作成システムと統合し、一貫性のあるデータ管理を実現する。

### 1.2 対象動画
- 対応形式: MP4, AVI, MOV等の一般的な動画形式
- 推奨解像度: 1920x1080 (フルHD) 以上
- 処理方式: ローカル処理を基本とし、大容量ファイルにも対応

### 1.3 既存システムとの関係
本システムは、既存の`haihu-generator`プロジェクトの一部として実装され、以下の既存コンポーネントを活用・拡張する：
- `hand_training_system/`: 既存の手牌トレーニングシステム基盤
- `src/training/semi_auto_labeler.py`: 半自動ラベリング機能
- `web_interface/`: 既存のWebインターフェース基盤
- `src/training/dataset_manager.py`: データセット管理機能

## 2. 機能要件

### 2.1 主要機能

#### 2.1.1 動画フレーム抽出（既存機能の拡張）
- `hand_training_system/backend/core/frame_extractor.py`の機能を活用
- 動画から適切な間隔でフレームを抽出（デフォルト：1秒間隔）
- 手牌が変化するタイミングを自動検出（`detect_hand_changes`メソッド）
- 任意のフレームへのジャンプ機能
- メタデータの自動保存と管理

#### 2.1.2 手牌領域検出（既存機能の拡張）
- `hand_training_system/backend/core/hand_area_detector.py`の機能を活用
- 各プレイヤー（4人）の手牌領域を設定
  - bottom：自分（対局者視点）
  - top：対面
  - left/right：左右のプレイヤー
- 手動での領域調整機能（Webインターフェース経由）
- 設定のJSON形式での保存と再利用

#### 2.1.3 牌の分割と認識（既存機能の統合）
- `hand_training_system/backend/core/tile_splitter.py`による自動分割
- `src/training/semi_auto_labeler.py`の既存AIモデル統合
- `src/detection/tile_detector.py`と`src/classification/tile_classifier.py`の活用
- 分割結果の手動調整インターフェース

#### 2.1.4 ラベリングインターフェース（新規開発）
- 分割された各牌に対する効率的なラベル付け
- キーボードショートカットによる高速入力
- 自動認識結果の確認・修正（信頼度表示付き）
- バッチ処理機能
- リアルタイム進捗表示

#### 2.1.5 データ管理（既存機能の活用）
- `src/training/dataset_manager.py`によるバージョン管理
- SQLiteデータベース（`data/training/dataset.db`）での一元管理
- 作業進捗の自動保存・再開機能
- データの検証とレビュー機能
- 天鳳JSON形式との互換性維持
- エクスポート機能（COCO、YOLO、天鳳形式）

## 3. システムアーキテクチャ

### 3.1 全体構成

```
haihu-generator（既存プロジェクト）
│
├── hand_labeling_system/（拡張）
│   ├── frontend/（Vue.js/React）
│   │   ├── 動画プレビュー・ナビゲーション
│   │   ├── 手牌領域設定ツール
│   │   ├── ラベリングインターフェース
│   │   └── データ管理画面
│   └── backend/（APIエンドポイント）
│       └── ラベリング専用API
│
├── hand_training_system/（既存・活用）
│   └── backend/
│       └── core/
│           ├── frame_extractor.py（活用）
│           ├── hand_area_detector.py（活用）
│           └── tile_splitter.py（新規作成予定）
│
├── web_interface/（既存・拡張）
│   ├── app.py（ルーティング追加）
│   ├── templates/
│   │   └── labeling.html（新規）
│   └── static/
│       └── js/
│           └── labeling.js（新規）
│
├── src/
│   ├── training/（既存・活用）
│   │   ├── semi_auto_labeler.py（活用）
│   │   ├── dataset_manager.py（活用）
│   │   └── annotation_data.py（活用）
│   ├── detection/（既存・活用）
│   │   └── tile_detector.py
│   └── classification/（既存・活用）
│       └── tile_classifier.py
│
└── data/
    └── training/（既存・活用）
        ├── frames/（フレーム画像）
        ├── tiles/（分割牌画像）
        ├── annotations/（アノテーションデータ）
        ├── dataset.db（SQLiteデータベース）
        └── exports/（エクスポートデータ）
```

### 3.2 技術スタック

#### パッケージ管理
- **uv**（プロジェクト標準のPythonパッケージマネージャー）
- pyproject.toml によるプロジェクト依存関係管理

#### フロントエンド
- HTML5/CSS3/JavaScript
- 既存の`web_interface/`で使用されているフレームワーク（確認要）
- Canvas API（画像編集・領域選択）
- キーボードショートカット管理ライブラリ

#### バックエンド
- Python 3.11+（プロジェクト標準）
- Flask（既存の`web_interface/app.py`を拡張）
- OpenCV（既存：画像処理）
- PyTorch（既存：AI推論）
- SQLite（既存：`data/training/dataset.db`）
- 既存ライブラリ群（requirements.txtおよびpyproject.toml参照）

## 4. データフロー

### 4.1 初期設定フロー
1. 動画ファイルをアップロード/選択
2. 最初のフレームを表示
3. 各プレイヤーの手牌領域を設定
4. 領域設定を保存

### 4.2 ラベリングフロー
1. フレームを自動/手動で選択
2. 手牌領域から牌を自動分割
3. AI補助による自動認識（オプション）
4. ユーザーによる確認・修正
5. ラベルデータを保存

### 4.3 データエクスポートフロー
1. エクスポート対象を選択
2. 出力形式を選択（COCO、YOLO等）
3. データ検証
4. エクスポート実行

## 5. ユーザーインターフェース設計

### 5.1 メイン画面構成
```
┌─────────────────────────────────────────────────────┐
│  メニューバー（ファイル｜編集｜表示｜ツール｜ヘルプ）        │
├─────────────────────────────────────────────────────┤
│  ┌─────────────────┐  ┌──────────────────────┐  │
│  │                   │  │                        │  │
│  │   動画プレビュー    │  │   ラベリングパネル      │  │
│  │                   │  │                        │  │
│  │                   │  │  ┌──┐┌──┐┌──┐    │  │
│  │                   │  │  │牌1││牌2││牌3│... │  │
│  │                   │  │  └──┘└──┘└──┘    │  │
│  └─────────────────┘  │                        │  │
│  ┌─────────────────┐  │  ラベル: [1m][2m][3m]  │  │
│  │  タイムライン      │  │                        │  │
│  └─────────────────┘  └──────────────────────┘  │
├─────────────────────────────────────────────────────┤
│  ステータスバー（進捗: 150/2000フレーム）              │
└─────────────────────────────────────────────────────┘
```

### 5.2 キーボードショートカット
- 数字キー（1-9）：数牌の数字
- Q/W/E：マンズ/ピンズ/ソーズの切り替え
- A/S/D/F/G/H/J：字牌（東南西北白發中）
- Space：次の牌へ
- Backspace：前の牌へ
- Enter：現在のフレームを確定
- Ctrl+S：保存

## 6. 実装計画

### Phase 1: 既存システムの統合と基盤整備（3日）
- [ ] 既存の`hand_training_system`コンポーネントの動作確認
- [ ] `web_interface`への新規ルーティング追加
- [ ] 必要な依存関係の追加（`uv add`コマンド使用）
- [ ] 基本的なラベリング画面のプロトタイプ作成

### Phase 2: コア機能の実装（5日）
- [ ] `tile_splitter.py`の実装（手牌領域から個別牌への分割）
- [ ] ラベリングUIの実装（Vue.js/vanilla JS）
- [ ] キーボードショートカットの実装
- [ ] `semi_auto_labeler.py`との統合

### Phase 3: データ管理機能の強化（3日）
- [ ] `dataset_manager.py`との統合
- [ ] 進捗管理・再開機能の実装
- [ ] データ検証機能の実装
- [ ] エクスポート機能（COCO、YOLO、天鳳形式）

### Phase 4: テストと最適化（2日）
- [ ] 単体テストの作成（pytest使用）
- [ ] 統合テストの実施
- [ ] パフォーマンス最適化
- [ ] ドキュメントの整備

## 7. 拡張可能性

### 7.1 将来的な機能追加
- 複数動画の一括処理
- チーム作業のサポート（複数ユーザー）
- 牌の向き（横向き）の検出とラベリング
- リアルタイム動画処理
- クラウドストレージ対応

### 7.2 他システムとの連携
- 既存の麻雀AI学習システムとの統合
- 学習済みモデルの評価システム
- データ品質分析ツール

## 8. 品質保証

### 8.1 データ品質基準
- ラベル精度目標：95%以上（段階的に向上）
- 画像品質：牌が明確に識別可能（最小解像度：32x48ピクセル）
- データ整合性：重複や欠損がない
- 信頼度スコア：0.8以上を高品質データとして扱う

### 8.2 検証方法
- `src/validation/quality_validator.py`の活用
- ランダムサンプリングによる手動チェック（10%）
- 自動検証スクリプトの実行
- クロスバリデーションによる精度確認
- `confidence_calculator.py`による信頼度評価

## 9. セキュリティとプライバシー

### 9.1 考慮事項
- 動画に含まれる個人情報の保護
  - 顔認識領域の自動マスキング機能
  - プレイヤー名の匿名化
- ローカル処理の徹底（クラウド未使用）
- データアクセス制御
  - ローカルファイルシステムベース
  - 必要に応じたアクセス権限設定

## 10. 開発上の注意事項

### 10.1 開発環境のセットアップ
```bash
# 依存関係のインストール（uvを使用）
uv sync

# 開発用依存関係の追加
uv add --dev pytest pytest-cov black isort flake8 mypy

# 仮想環境の有効化
source .venv/bin/activate  # Linux/macOS
```

### 10.2 既存コードとの整合性
- 既存のコーディング規約に従う（Black、isort使用）
- 既存のロギングシステム（`src/utils/logger.py`）を使用
- 設定は`config.yaml`に集約
- テストは`tests/`ディレクトリに配置

### 10.3 パフォーマンス考慮事項
- 大容量動画ファイルの処理時のメモリ管理
- バッチ処理による効率化
- キャッシュの活用（`src/utils/cache_manager.py`）
- GPU利用時の最適化（`src/optimization/gpu_optimizer.py`）

## 11. まとめ

本システムは、既存の`haihu-generator`プロジェクトの一部として、麻雀対局動画から高品質な手牌学習データを効率的に作成することを目的としています。既存のコンポーネントを最大限活用することで、開発期間を短縮し、システム全体の一貫性を保ちながら、ユーザーフレンドリーなラベリングツールを提供します。

### 主な特徴
1. **既存資産の活用**: 既に実装済みの機能を最大限活用
2. **統合的なデータ管理**: 既存のデータベースとの統合
3. **AI補助による効率化**: 半自動ラベリング機能
4. **柔軟な拡張性**: 将来的な機能追加を考慮した設計
5. **品質重視**: 段階的な品質向上を目指す現実的なアプローチ

総開発期間：約2週間（13営業日）
