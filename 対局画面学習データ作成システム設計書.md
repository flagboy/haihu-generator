# 対局画面学習データ作成システム設計書

## 1. 概要

### 1.1 システムの目的
麻雀動画から対局画面（実際にゲームが行われているシーン）と非対局画面（CM、待機画面、リザルト画面など）を自動的に識別し、学習データを作成するシステムです。これにより、手牌学習データ作成システムや牌譜作成システムが非対局フレームをスキップすることで、処理効率を大幅に向上させます。

### 1.2 主な機能
- 動画フレームから対局/非対局を分類
- 対局画面の特徴を学習するモデルの構築
- ラベリングインターフェースによる学習データ作成
- 既存システムとの連携によるフレームスキップ機能

## 2. システムアーキテクチャ

### 2.1 コンポーネント構成

```
src/training/game_scene/
├── __init__.py
├── core/
│   ├── __init__.py
│   ├── game_scene_classifier.py      # 対局画面分類器
│   ├── feature_extractor.py          # 特徴量抽出
│   └── scene_detector.py             # シーン検出器
├── labeling/
│   ├── __init__.py
│   ├── scene_labeling_session.py    # ラベリングセッション管理
│   └── api/
│       ├── __init__.py
│       └── scene_routes.py           # APIエンドポイント
├── learning/
│   ├── __init__.py
│   ├── scene_trainer.py              # モデル学習
│   └── scene_dataset.py              # データセット管理
└── utils/
    ├── __init__.py
    └── scene_analyzer.py             # シーン分析ユーティリティ
```

### 2.2 データフロー

1. **入力**: 麻雀動画（手牌学習データ作成システムと同じ）
2. **フレーム抽出**: 一定間隔でフレームを抽出
3. **特徴量抽出**: 対局画面の特徴を抽出
4. **分類**: 対局/非対局を判定
5. **出力**: フレームごとの分類結果とメタデータ

## 3. 対局画面の特徴

### 3.1 視覚的特徴
- **牌の存在**: 麻雀牌が画面に表示されている
- **卓の存在**: 麻雀卓（緑色の背景）が見える
- **プレイヤー情報**: 点数表示、プレイヤー名
- **UI要素**: 残り牌数、局数表示、風牌表示

### 3.2 時系列特徴
- **動きのパターン**: 牌の移動、手牌の変化
- **画面の安定性**: 対局中は画面構成が一定
- **継続時間**: 対局シーンは一定時間継続

## 4. 機械学習モデル

### 4.1 モデルアーキテクチャ
```python
class GameSceneClassifier:
    """
    対局画面分類器

    モデル構成:
    - バックボーン: ResNet50/EfficientNet
    - 特徴量抽出: 画像特徴 + 色ヒストグラム + エッジ検出
    - 分類器: 2クラス分類（対局/非対局）
    """
```

### 4.2 学習戦略
- **転移学習**: ImageNetで事前学習済みモデルを使用
- **データ拡張**: 輝度変化、ノイズ追加で汎化性能向上
- **クラスバランス**: 対局/非対局の比率を調整

## 5. ラベリングインターフェース

### 5.1 UI設計
```
┌─────────────────────────────────────┐
│  対局画面ラベリング                    │
├─────────────────────────────────────┤
│  [動画プレビュー]                      │
│  ┌─────────────────┐                │
│  │                 │                │
│  │  フレーム画像    │                │
│  │                 │                │
│  └─────────────────┘                │
│                                     │
│  フレーム: 1234/5000                 │
│  [←前] [対局] [非対局] [次→]          │
│                                     │
│  ショートカットキー:                   │
│  - G: 対局画面                       │
│  - N: 非対局画面                     │
│  - Space: 次のフレーム                │
│                                     │
│  自動推論結果: 対局 (信頼度: 0.85)     │
└─────────────────────────────────────┘
```

### 5.2 効率的なラベリング
- **自動推論支援**: AIによる事前分類結果を表示
- **バッチラベリング**: 連続フレームの一括ラベリング
- **不確実なフレーム優先**: 信頼度の低いフレームを優先表示

## 6. 既存システムとの統合

### 6.1 フレームスキップAPI
```python
class FrameSkipManager:
    """フレームスキップ管理"""

    def should_skip_frame(self, video_id: str, frame_number: int) -> bool:
        """フレームをスキップすべきか判定"""

    def get_game_scenes(self, video_id: str) -> List[Tuple[int, int]]:
        """対局シーンの開始・終了フレーム番号のリストを返す"""
```

### 6.2 統合ポイント
- **手牌学習データ作成システム**: 非対局フレームをスキップして手牌抽出
- **牌譜作成システム**: 対局シーンのみを解析対象に
- **ビデオプロセッサー**: フレーム抽出時にフィルタリング

## 7. データベース設計

### 7.1 テーブル構造
```sql
-- 対局シーンラベル
CREATE TABLE game_scene_labels (
    id INTEGER PRIMARY KEY,
    video_id TEXT NOT NULL,
    frame_number INTEGER NOT NULL,
    is_game_scene BOOLEAN NOT NULL,
    confidence REAL,
    annotator TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(video_id, frame_number)
);

-- 対局シーンセグメント
CREATE TABLE game_scene_segments (
    id INTEGER PRIMARY KEY,
    video_id TEXT NOT NULL,
    start_frame INTEGER NOT NULL,
    end_frame INTEGER NOT NULL,
    confidence REAL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

## 8. パフォーマンス最適化

### 8.1 推論の高速化
- **バッチ処理**: 複数フレームを同時処理
- **キャッシュ**: 分類結果をキャッシュ
- **軽量モデル**: MobileNet等の軽量モデルオプション

### 8.2 メモリ効率
- **オンデマンド読み込み**: 必要なフレームのみメモリに保持
- **特徴量キャッシュ**: 中間特徴量を保存して再利用

## 9. 評価指標

### 9.1 分類性能
- **精度 (Accuracy)**: 全体の正解率
- **適合率 (Precision)**: 対局と判定した中の正解率
- **再現率 (Recall)**: 実際の対局シーンの検出率
- **F1スコア**: 適合率と再現率の調和平均

### 9.2 実用性評価
- **処理時間削減率**: スキップによる時間短縮
- **誤検出の影響**: 対局シーンの見逃しによる影響評価

## 10. 実装計画

### Phase 1: 基礎実装（1週間）
- GameSceneClassifierの実装
- 基本的な特徴量抽出器
- シンプルなCNNモデル

### Phase 2: ラベリングシステム（1週間）
- Webインターフェースの実装
- ラベリングワークフロー
- データベース連携

### Phase 3: 学習・評価（1週間）
- モデル学習パイプライン
- 評価システム
- ハイパーパラメータ調整

### Phase 4: システム統合（1週間）
- 既存システムとのAPI連携
- フレームスキップ機能の実装
- 統合テスト

## 11. 将来の拡張

### 11.1 高度な分類
- **シーンの細分類**: 配牌、打牌、リーチ、和了などの詳細分類
- **イベント検出**: 特定のゲームイベントの検出

### 11.2 リアルタイム処理
- **ストリーミング対応**: リアルタイム配信の対局検出
- **低遅延推論**: エッジデバイスでの推論

### 11.3 多様な麻雀ゲーム対応
- **異なるUI対応**: 様々な麻雀ゲームのUI認識
- **転移学習**: 新しいゲームへの迅速な適応
