# DatasetManager分析レポート

## 現状の問題点

### 1. 責務の混在（775行）
DatasetManagerが以下の複数の責務を持っている：
- **データベース操作**: SQLiteの直接操作（CREATE TABLE、INSERT、SELECT）
- **ファイルシステム管理**: ディレクトリ作成、ファイル保存
- **データ変換**: アノテーションデータとDBスキーマ間の変換
- **エクスポート処理**: YOLO、COCO、Pascal VOC形式への変換
- **統計情報の計算**: データセットの統計情報生成
- **バージョン管理**: データセットのバージョニング
- **チェックサム計算**: ファイルのMD5ハッシュ計算

### 2. SQLクエリの散在
- 生のSQLクエリが至る所に記述されている
- テーブル構造の変更が困難
- SQLインジェクションのリスク（現在は問題ないが、将来的なリスク）

### 3. エラーハンドリングの問題
- 各メソッドで独自のtry-except
- エラーログのみで適切な例外の再スロー無し
- トランザクション管理が不完全

### 4. テスタビリティの低さ
- データベースに直接依存
- モックが困難
- 単体テストが書きにくい

## リファクタリング設計

### Repository Pattern の導入

```
src/training/
├── data/
│   ├── repositories/
│   │   ├── base_repository.py      # 基底リポジトリ
│   │   ├── video_repository.py     # 動画データアクセス
│   │   ├── frame_repository.py     # フレームデータアクセス
│   │   ├── annotation_repository.py # アノテーションデータアクセス
│   │   └── version_repository.py    # バージョン管理
│   ├── services/
│   │   ├── dataset_service.py      # データセット操作のビジネスロジック
│   │   ├── export_service.py       # エクスポート処理
│   │   └── statistics_service.py   # 統計情報計算
│   ├── models/
│   │   ├── video.py                # 動画エンティティ
│   │   ├── frame.py                # フレームエンティティ
│   │   ├── annotation.py           # アノテーションエンティティ
│   │   └── version.py              # バージョンエンティティ
│   └── database/
│       ├── connection.py           # DB接続管理
│       └── migrations.py           # スキーマ管理
```

### 責務の分離

1. **Repositories（データアクセス層）**
   - SQLクエリの隠蔽
   - CRUDオペレーション
   - データベースとの直接やりとり

2. **Services（ビジネスロジック層）**
   - 複数のリポジトリを調整
   - ビジネスルールの実装
   - トランザクション管理

3. **Models（ドメインモデル）**
   - データの構造定義
   - バリデーション
   - ビジネスロジック（エンティティに属するもの）

### 主な改善点

1. **単一責任の原則**: 各クラスが1つの責任のみを持つ
2. **依存性逆転の原則**: インターフェースに依存
3. **テスタビリティ**: リポジトリをモック可能に
4. **保守性**: SQLクエリが一箇所に集約
5. **拡張性**: 新しいエクスポート形式の追加が容易
